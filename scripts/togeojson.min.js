var toGeoJSON=function(){"use strict";var removeSpace=/\s*/g,trimSpace=/^\s*|\s*$/g,splitSpace=/\s+/,serializer,t;function okhash(x){if(!x||!x.length)return 0;for(var i=0,h=0;i<x.length;i++)h=(h<<5)-h+x.charCodeAt(i)|0;return h}function get(x,y){return x.getElementsByTagName(y)}function attr(x,y){return x.getAttribute(y)}function attrf(x,y){return parseFloat(attr(x,y))}function get1(x,y){var n=get(x,y);return n.length?n[0]:null}function norm(el){return el.normalize&&el.normalize(),el}function numarray(x){for(var j=0,o=[];j<x.length;j++)o[j]=parseFloat(x[j]);return o}function nodeVal(x){return x&&norm(x),x&&x.textContent||""}function getMulti(x,ys){var o={},n,k;for(k=0;k<ys.length;k++)(n=get1(x,ys[k]))&&(o[ys[k]]=nodeVal(n));return o}function extend(x,y){for(var k in y)x[k]=y[k]}function coord1(v){return numarray(v.replace(removeSpace,"").split(","))}function coord(v){for(var coords=v.replace(trimSpace,"").split(splitSpace),o=[],i=0;i<coords.length;i++)o.push(coord1(coords[i]));return o}function coordPair(x){var ll=[attrf(x,"lon"),attrf(x,"lat")],ele=get1(x,"ele"),heartRate=get1(x,"gpxtpx:hr")||get1(x,"hr"),time=get1(x,"time"),e;return ele&&(e=parseFloat(nodeVal(ele)),isNaN(e)||ll.push(e)),{coordinates:ll,time:time?nodeVal(time):null,heartRate:heartRate?parseFloat(nodeVal(heartRate)):null}}function fc(){return{type:"FeatureCollection",features:[]}}if("undefined"!=typeof XMLSerializer)serializer=new XMLSerializer;else{var isNodeEnv="object"==typeof process&&!process.browser,isTitaniumEnv="object"==typeof Titanium;if("object"!=typeof exports||!isNodeEnv&&!isTitaniumEnv)throw new Error("Unable to initialize serializer");serializer=new(require("xmldom").XMLSerializer)}function xml2str(str){return void 0!==str.xml?str.xml:serializer.serializeToString(str)}return{kml:function(doc){for(var gj={type:"FeatureCollection",features:[]},styleIndex={},styleByHash={},styleMapIndex={},geotypes=["Polygon","LineString","Point","Track","gx:Track"],placemarks=get(doc,"Placemark"),styles=get(doc,"Style"),styleMaps=get(doc,"StyleMap"),k=0;k<styles.length;k++){var hash=okhash(xml2str(styles[k])).toString(16);styleIndex["#"+attr(styles[k],"id")]=hash,styleByHash[hash]=styles[k]}for(var l=0;l<styleMaps.length;l++){styleIndex["#"+attr(styleMaps[l],"id")]=okhash(xml2str(styleMaps[l])).toString(16);for(var pairs=get(styleMaps[l],"Pair"),pairsMap={},m=0;m<pairs.length;m++)pairsMap[nodeVal(get1(pairs[m],"key"))]=nodeVal(get1(pairs[m],"styleUrl"));styleMapIndex["#"+attr(styleMaps[l],"id")]=pairsMap}for(var j=0;j<placemarks.length;j++)gj.features=gj.features.concat(getPlacemark(placemarks[j]));function kmlColor(v){var color,opacity;return"#"===(v=v||"").substr(0,1)&&(v=v.substr(1)),6!==v.length&&3!==v.length||(color=v),8===v.length&&(opacity=parseInt(v.substr(0,2),16)/255,color="#"+v.substr(6,2)+v.substr(4,2)+v.substr(2,2)),[color,isNaN(opacity)?void 0:opacity]}function gxCoord(v){return numarray(v.split(" "))}function gxCoords(root){var elems=get(root,"coord","gx"),coords=[],times=[];0===elems.length&&(elems=get(root,"gx:coord"));for(var i=0;i<elems.length;i++)coords.push(gxCoord(nodeVal(elems[i])));for(var timeElems=get(root,"when"),j=0;j<timeElems.length;j++)times.push(nodeVal(timeElems[j]));return{coords:coords,times:times}}function getGeometry(root){var geomNode,geomNodes,i,j,k,geoms=[],coordTimes=[];if(get1(root,"MultiGeometry"))return getGeometry(get1(root,"MultiGeometry"));if(get1(root,"MultiTrack"))return getGeometry(get1(root,"MultiTrack"));if(get1(root,"gx:MultiTrack"))return getGeometry(get1(root,"gx:MultiTrack"));for(i=0;i<geotypes.length;i++)if(geomNodes=get(root,geotypes[i]))for(j=0;j<geomNodes.length;j++)if(geomNode=geomNodes[j],"Point"===geotypes[i])geoms.push({type:"Point",coordinates:coord1(nodeVal(get1(geomNode,"coordinates")))});else if("LineString"===geotypes[i])geoms.push({type:"LineString",coordinates:coord(nodeVal(get1(geomNode,"coordinates")))});else if("Polygon"===geotypes[i]){var rings=get(geomNode,"LinearRing"),coords=[];for(k=0;k<rings.length;k++)coords.push(coord(nodeVal(get1(rings[k],"coordinates"))));geoms.push({type:"Polygon",coordinates:coords})}else if("Track"===geotypes[i]||"gx:Track"===geotypes[i]){var track=gxCoords(geomNode);geoms.push({type:"LineString",coordinates:track.coords}),track.times.length&&coordTimes.push(track.times)}return{geoms:geoms,coordTimes:coordTimes}}function getPlacemark(root){var geomsAndTimes=getGeometry(root),i,properties={},name=nodeVal(get1(root,"name")),address=nodeVal(get1(root,"address")),styleUrl=nodeVal(get1(root,"styleUrl")),description=nodeVal(get1(root,"description")),timeSpan=get1(root,"TimeSpan"),timeStamp=get1(root,"TimeStamp"),extendedData=get1(root,"ExtendedData"),lineStyle=get1(root,"LineStyle"),polyStyle=get1(root,"PolyStyle"),visibility=get1(root,"visibility");if(!geomsAndTimes.geoms.length)return[];if(name&&(properties.name=name),address&&(properties.address=address),styleUrl){"#"!==styleUrl[0]&&(styleUrl="#"+styleUrl),properties.styleUrl=styleUrl,styleIndex[styleUrl]&&(properties.styleHash=styleIndex[styleUrl]),styleMapIndex[styleUrl]&&(properties.styleMapHash=styleMapIndex[styleUrl],properties.styleHash=styleIndex[styleMapIndex[styleUrl].normal]);var style=styleByHash[properties.styleHash];if(style){lineStyle||(lineStyle=get1(style,"LineStyle")),polyStyle||(polyStyle=get1(style,"PolyStyle"));var iconStyle=get1(style,"IconStyle");if(iconStyle){var icon=get1(iconStyle,"Icon");if(icon){var href=nodeVal(get1(icon,"href"));href&&(properties.icon=href)}}}}if(description&&(properties.description=description),timeSpan){var begin=nodeVal(get1(timeSpan,"begin")),end=nodeVal(get1(timeSpan,"end"));properties.timespan={begin:begin,end:end}}if(timeStamp&&(properties.timestamp=nodeVal(get1(timeStamp,"when"))),lineStyle){var linestyles=kmlColor(nodeVal(get1(lineStyle,"color"))),color=linestyles[0],opacity=linestyles[1],width=parseFloat(nodeVal(get1(lineStyle,"width")));color&&(properties.stroke=color),isNaN(opacity)||(properties["stroke-opacity"]=opacity),isNaN(width)||(properties["stroke-width"]=width)}if(polyStyle){var polystyles=kmlColor(nodeVal(get1(polyStyle,"color"))),pcolor=polystyles[0],popacity=polystyles[1],fill=nodeVal(get1(polyStyle,"fill")),outline=nodeVal(get1(polyStyle,"outline"));pcolor&&(properties.fill=pcolor),isNaN(popacity)||(properties["fill-opacity"]=popacity),fill&&(properties["fill-opacity"]="1"===fill?properties["fill-opacity"]||1:0),outline&&(properties["stroke-opacity"]="1"===outline?properties["stroke-opacity"]||1:0)}if(extendedData){var datas=get(extendedData,"Data"),simpleDatas=get(extendedData,"SimpleData");for(i=0;i<datas.length;i++)properties[datas[i].getAttribute("name")]=nodeVal(get1(datas[i],"value"));for(i=0;i<simpleDatas.length;i++)properties[simpleDatas[i].getAttribute("name")]=nodeVal(simpleDatas[i])}visibility&&(properties.visibility=nodeVal(visibility)),geomsAndTimes.coordTimes.length&&(properties.coordTimes=1===geomsAndTimes.coordTimes.length?geomsAndTimes.coordTimes[0]:geomsAndTimes.coordTimes);var feature={type:"Feature",geometry:1===geomsAndTimes.geoms.length?geomsAndTimes.geoms[0]:{type:"GeometryCollection",geometries:geomsAndTimes.geoms},properties:properties};return attr(root,"id")&&(feature.id=attr(root,"id")),[feature]}return gj},gpx:function(doc){var i,tracks=get(doc,"trk"),routes=get(doc,"rte"),waypoints=get(doc,"wpt"),gj={type:"FeatureCollection",features:[]},feature;for(i=0;i<tracks.length;i++)(feature=getTrack(tracks[i]))&&gj.features.push(feature);for(i=0;i<routes.length;i++)(feature=getRoute(routes[i]))&&gj.features.push(feature);for(i=0;i<waypoints.length;i++)gj.features.push(getPoint(waypoints[i]));function initializeArray(arr,size){for(var h=0;h<size;h++)arr.push(null);return arr}function getPoints(node,pointname){var pts=get(node,pointname),line=[],times=[],heartRates=[],l=pts.length;if(l<2)return{};for(var i=0;i<l;i++){var c=coordPair(pts[i]);line.push(c.coordinates),c.time&&times.push(c.time),(c.heartRate||heartRates.length)&&(heartRates.length||initializeArray(heartRates,i),heartRates.push(c.heartRate||null))}return{line:line,times:times,heartRates:heartRates}}function getTrack(node){for(var segments=get(node,"trkseg"),track=[],times=[],heartRates=[],line,i=0;i<segments.length;i++)if((line=getPoints(segments[i],"trkpt"))&&(line.line&&track.push(line.line),line.times&&line.times.length&&times.push(line.times),heartRates.length||line.heartRates&&line.heartRates.length)){if(!heartRates.length)for(var s=0;s<i;s++)heartRates.push(initializeArray([],track[s].length));line.heartRates&&line.heartRates.length?heartRates.push(line.heartRates):heartRates.push(initializeArray([],line.line.length||0))}if(0!==track.length){var properties=getProperties(node);return extend(properties,getLineStyle(get1(node,"extensions"))),times.length&&(properties.coordTimes=1===track.length?times[0]:times),heartRates.length&&(properties.heartRates=1===track.length?heartRates[0]:heartRates),{type:"Feature",properties:properties,geometry:{type:1===track.length?"LineString":"MultiLineString",coordinates:1===track.length?track[0]:track}}}}function getRoute(node){var line=getPoints(node,"rtept");if(line.line){var prop=getProperties(node),routeObj;return extend(prop,getLineStyle(get1(node,"extensions"))),{type:"Feature",properties:prop,geometry:{type:"LineString",coordinates:line.line}}}}function getPoint(node){var prop=getProperties(node);return extend(prop,getMulti(node,["sym"])),{type:"Feature",properties:prop,geometry:{type:"Point",coordinates:coordPair(node).coordinates}}}function getLineStyle(extensions){var style={};if(extensions){var lineStyle=get1(extensions,"line");if(lineStyle){var color=nodeVal(get1(lineStyle,"color")),opacity=parseFloat(nodeVal(get1(lineStyle,"opacity"))),width=parseFloat(nodeVal(get1(lineStyle,"width")));color&&(style.stroke=color),isNaN(opacity)||(style["stroke-opacity"]=opacity),isNaN(width)||(style["stroke-width"]=96*width/25.4)}}return style}function getProperties(node){var prop=getMulti(node,["name","cmt","desc","type","time","keywords"]),links=get(node,"link");links.length&&(prop.links=[]);for(var i=0,link;i<links.length;i++)extend(link={href:attr(links[i],"href")},getMulti(links[i],["text","type"])),prop.links.push(link);return prop}return gj}}}();"undefined"!=typeof module&&(module.exports=toGeoJSON);