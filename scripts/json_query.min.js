/*
 * JsonQuery
 * 0.0.2 (2015-02-24)
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 * Copyright 2011-2015 Jiren Patel[jirenpatel@gmail.com]
 *
 */
!function(t){"use strict";var r=function(t,r){return new n(t,r||{})};t.JsonQuery=r,r.VERSION="0.0.2",Object.defineProperty||(Object.defineProperty=function(t,r,i){t[r]=i.get});var i=function(t,r,i){if(t.length===+t.length)for(var e=0,n=t.length;n>e;e++)r.call(i,t[e],e);else for(var s in t)hasOwnProperty.call(t,s)&&r.call(i,t[s],s)},e=function(t,r,i){for(var e=0,n=t.length;n>e;e++)if(r.call(i,t[e],e)===!1)return},n=function(t,r){this.records=t||[],this.getterFns=r.getterFns||{},this.lat=r.latitude||"latitude",this.lng=r.longitude||"longitude",this.id=r.id,this.records.length&&c(this,t[0],r.schema)},s=n.prototype,c=function(t,r,i){t.schema={},t.id||(t.id=r._id?"_id":"id"),i||(a.call(t,r),h.call(t,r))},o=function(t){if(null==t)return"String";/*
     * @info Fix for IE 10 & 11
     * @bug Invalid calling object
     */
var r=Object.prototype.toString.call(t).slice(8,-1);return"String"==r&&t.match(/\d{4}-\d{2}-\d{2}/)?"Date":r},a=function(t,r){var i,e,n,s;for(i in t)s=t[i],e=o(s),n=r?r+"."+i:i,this.schema[n]=e,"Object"==e?a.call(this,s,n):"Array"==e&&(["Object","Array"].indexOf(o(s[0]))>-1?a.call(this,t[i][0],n):this.schema[n]=o(s[0]))},h=function(t){var r,i,e;for(r in this.schema){i=this.schema[r];try{this.getterFns[r]||(this.getterFns[r]=l.call(this,r,i)),//Remap if it is array
e=this.getterFns[r](t),"Array"==o(e)&&(this.schema[r]="Array")}catch(n){console.log("Error while generating getter function for selector : "+r+" NOTE: Define manually")}}},u=function(t,r){for(var i,e=0,n=0,s=r.length-1,c=r.length-1;c>=0;c--)i=r.slice(0,c+1).join("."),"Array"==t[i]&&s>c&&(e=c,n+=1);return n>1?e+1:-1},l=function(t){for(var r,i,e,n="",s=t.split("."),c=u(this.schema,s),o=s.length-1;o>=0;o--)r=s.slice(0,o+1).join("."),i="['"+s[o]+"']",n="Array"==this.schema[r]?c==o?i+(n.length?".every(function(r"+o+"){  objs.push(r"+o+n+")})":""):i+(n.length?".map(function(r"+o+"){  return r"+o+n+"})":""):i+n;return e=c>-1?"var objs = []; obj"+n+";"+("Date"==this.schema.path?"return parseDate(objs)":"return objs;"):"return "+("Date"==this.schema.path?"parseDate(obj"+n+");":"obj"+n+";"),new Function("obj",e)};s.operators={eq:function(t,r){return t==r},ne:function(t,r){return t!=r},lt:function(t,r){return r>t},lte:function(t,r){return r>=t},gt:function(t,r){return t>r},gte:function(t,r){return t>=r},"in":function(t,r){return r.indexOf(t)>-1},ni:function(t,r){return-1==r.indexOf(t)},li:function(t,r){return r.test(t)},bt:function(t,r){return t>=r[0]&&t<=r[1]}},s.addOperator=function(t,r){this.operators[t]=r};// rVal = Record Value
// cVal = Condition Value
var f=function(t,r,i){var e=0,n=t.length;for(e;n>e;e++)if(i(t[e],r))return!0};s.addCondition=function(t,r){this.operators[t]=r},s.getCriteria=function(t){var r=t.split(".$");return{field:r[0],operator:r[1]||"eq"}},s.setGetterFn=function(t,r){this.getterFns[t]=r},s.addRecords=function(t){return t&&t.length?("Array"==o(t)?this.records=this.records.concat(t):this.records.push(t),this.schema||c(this,t[0]),!0):!1},s._findAll=function(t,r,e,n){var s,c,o,a=[],h=this.getterFns[r];return"li"==n&&"string"==typeof e&&(e=new RegExp(e)),s=this.operators[n],"Array"==this.schema[r]&&(o=s,s=f),i(t,function(t){c=h(t),s(c,e,o)&&a.push(t)}),a},s.find=function(t,r){var i,n;return r||(r=t,t=this.id),n=this.getterFns[t],e(this.records,function(t){return n(t)==r?(i=t,!1):void 0}),i},i(["where","or","groupBy","select","pluck","limit","offset","order","uniq","near"],function(t){s[t]=function(){var r=new b(this,this.records);return r[t].apply(r,arguments),r}}),i(["update_all","destroy_all"],function(t){s[t]=function(){var r=new b(this,this.records);return r[t].apply(r,arguments)}}),i(["count","first","last","all"],function(t){Object.defineProperty(s,t,{get:function(){return new b(this,this.records)[t]}})});var d=function(t,r,i){for(var e=0,n=i.length;n>e;e++)if(this.getterFns[i[e]](t)!==this.getterFns[i[e]](r))return!1;return!0},g=function(t,r){var i,e,n;for(i in t)e=this.jQ.getCriteria(i),n=this.jQ._findAll(n||r,e.field,t[i],e.operator);return n},p=function(t,r){{var e,n=this.jQ.getterFns[t],s={};r.length}return i(r,function(t){e=n(t),(s[e]||(s[e]=[])).push(t)}),s},v=function(t,r){for(var i,e,n=r.slice(0),s=0,c=t.length;c>s;s++)i=this.jQ.getterFns[t[s].field],e="asc"==t[s].direction?1:-1,n.sort(function(t,r){var n=i(t),s=i(r);return(s>n?-1:n>s?1:0)*e});return n},y=function(t,r){var e,n=this,s=[];return i(t,function(t){e=n.jQ.getterFns[t],i(r,function(r,i){(s[i]||(s[i]={}))[t]=e(r)})}),s},j=function(t,r){var e=this.jQ.getterFns[t],n=[];return i(r,function(t){n.push(e(t))}),n},m=function(t,r){var e=[],n=this;return"Object"!=o(r[0])?(i(r,function(t){-1==e.indexOf(t)&&e.push(t)}),e):(e.push(r[0]),i(r,function(r){for(var i=!1,s=0,c=e.length;c>s;s++)d.call(n.jQ,e[s],r,t)&&(i=!0);i||e.push(r)}),e)},b=function(t,r){return this.jQ=t,this.records=r,this.criteria={},this},O=b.prototype;O.each=function(t,r){i(this.exec()||[],t,r)},O.exec=O.toArray=function(t){var r;return this.criteria.all&&(r=this.records),this.criteria.where&&(r=g.call(this,this.criteria.where,r||this.records)),this.criteria.or&&(r=r.concat(g.call(this,this.criteria.or,this.records)),r=m.call(this,[this.jQ.id],r)),this.criteria.order&&(r=v.call(this,this.criteria.order,r||this.records)),this.criteria.near&&(r=x.call(this,this.criteria.near,r||this.records)),this.criteria.uniq&&(r=m.call(this,this.criteria.uniq,r||this.records)),this.criteria.select&&(r=y.call(this,this.criteria.select,r||this.records)),this.criteria.pluck&&(r=j.call(this,this.criteria.pluck,r||this.records)),this.criteria.limit&&(r=(r||this.records).slice(this.criteria.offset||0,(this.criteria.offset||0)+this.criteria.limit)),this.criteria.group_by&&(r=p.call(this,this.criteria.group_by,r||this.records)),r||(r=this.records),t&&i(r,t),this.jQ.onResult&&this.jQ.onResult(r,this.criteria),r};var _=function(t,r){var i;this.criteria[t]||(this.criteria[t]={});for(i in r)this.criteria[t][i]=r[i];return this};O.where=function(t){return _.call(this,"where",t)},O.or=function(t){return _.call(this,"or",t)},O.groupBy=function(t){return this.criteria.group_by=t,this},O.select=function(){return this.criteria.select=arguments,this},O.pluck=function(t){return this.criteria.pluck=t,this},O.limit=function(t){return this.criteria.limit=t,this},O.offset=function(t){return this.criteria.offset=t,this},O.order=function(t){var r;this.criteria.order=this.criteria.order||[];for(r in t)this.criteria.order.push({field:r,direction:t[r].toLowerCase()});return this},O.uniq=function(){return this.criteria.uniq=arguments.length>0?arguments:!0,this},Object.defineProperty(O,"count",{get:function(){this.criteria.count=!0;var t=this.exec();return"Array"==o(t)?this.exec().length:Object.keys(t).length}}),Object.defineProperty(O,"all",{get:function(){return this.criteria.all=!0,this.exec()}}),Object.defineProperty(O,"first",{get:function(){return this.criteria.first=!0,this.exec()[0]}}),Object.defineProperty(O,"last",{get:function(){this.criteria.last=!0;var t=this.exec();return t[t.length-1]}});//Geocoding
var F={redius:6371,toRad:function(t){return t*Math.PI/180}},Q=function(t,r,i,e){var n=F.toRad(r-t),s=F.toRad(e-i),t=F.toRad(t),r=F.toRad(r),c=Math.sin(n/2)*Math.sin(n/2)+Math.sin(s/2)*Math.sin(s/2)*Math.cos(t)*Math.cos(r);return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*F.redius},x=function(t,r){var e=[],n=this,s="mile"==t.unit?.6214:1,c=n.jQ.getterFns[n.jQ.lat],o=n.jQ.getterFns[n.jQ.lng];return i(r,function(r){r._distance=Q(c(r),t.lat,o(r),t.lng)*s,r._distance<=t.distance&&e.push(r)}),e.sort(function(t,r){return t._distance<r._distance?-1:t._distance>r._distance?1:0}),e};O.near=function(t,r,i,e){return this.criteria.near={lat:t,lng:r,distance:i,unit:e||"km"},this},//Helpers
O.map=O.collect=function(t){var r,i=[];return this.exec(function(e){(r=t(e))&&i.push(r)}),i},O.sum=function(t){var r,e=0,n=this.jQ.getterFns[t];return this.criteria.group_by&&(r=!0,e={}),this.exec(function(t,s){r?(e[s]=0,i(t,function(t){e[s]=e[s]+(n(t)||0)})):e+=n(t)||0}),e},O.toJQ=function(){var t=r(this.all,{schema:!0});return t.schema=this.jQ.schema,t.getterFns=this.jQ.getterFns,t},O.destroy_all=O.destroy=function(){var t=this.all;return i(t,function(t){t._destroy_=!0}),this.records=this.jQ.records=this.records.filter(function(t){return!t._destroy_}),t},O.update_all=O.update=function(t){if(!t)return!1;var r=0;return i(this.all,function(e){i(t,function(t,r){e[r]=t}),r+=1}),r},//In IE 8 indexOf method not define.
Array.prototype.indexOf||(Array.prototype.indexOf=function(t,r){for(var i=r||0,e=this.length;e>i;i++)if(this[i]===t)return i;return-1})}(this);